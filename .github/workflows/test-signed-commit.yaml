name: Test Signed Commit

on:
    push:
        branches:
            - dev
        paths:
            - '.github/workflows/test-signed-commit.yaml'
            - '.github/actions/signed-commit/**'

permissions:
    contents: read

jobs:
    test-signed-commit:
        name: Test GPG Signed Commit
        runs-on: ubuntu-latest
        permissions:
            id-token: write
            contents: read

        steps:
            - name: Checkout repository
              uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

            - name: Azure Login
              uses: ./.github/actions/az-login
              with:
                  client-id: ${{ secrets.OSUI_AZURE_CLIENT_ID }}
                  tenant-id: ${{ secrets.OSUI_AZURE_TENANT_ID }}
                  subscription-id: ${{ secrets.OSUI_AZURE_SUBSCRIPTION_ID }}

            - name: Get GitHub Token
              id: get-github-token
              uses: ./.github/actions/az-keyvault-get
              with:
                  key-name: o11odc-github-gitpersonal-token-prd

            - name: Get GPG Passphrase
              id: get-gpg-passphrase
              uses: ./.github/actions/az-keyvault-get
              with:
                  key-name: o11odc-github-gpg-passphrase-prd

            - name: Checkout branch with token
              uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
              with:
                  ref: ${{ github.ref_name }}
                  token: ${{ steps.get-github-token.outputs.az-keyvault-value }}

            - name: Create test change
              run: |
                  echo "Test commit at $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> .test-signed-commit.txt

            - name: Debug - Check GPG key format
              run: |
                  echo "=== Checking GPG key format ==="
                  echo "${{ secrets.GPG_SIGN_KEY }}" | head -c 100
                  echo ""
                  echo "=== Counting key blocks ==="
                  echo "${{ secrets.GPG_SIGN_KEY }}" | grep -c "BEGIN PGP PRIVATE KEY BLOCK" || echo "0 key blocks found"
                  echo "${{ secrets.GPG_SIGN_KEY }}" | grep -c "END PGP PRIVATE KEY BLOCK" || echo "0 end blocks found"

            - name: Sign and commit
              uses: ./.github/actions/signed-commit
              with:
                  commit-branch: ${{ github.ref_name }}
                  commit-message: 'Test signed commit [skip ci]'
                  commit-new-files: true
                  gpg-priv-key: ${{ secrets.GPG_SIGN_KEY }}
                  gpg-pass-phrase: ${{ steps.get-gpg-passphrase.outputs.az-keyvault-value }}
