#
# This action enables to perform signed commits. 
# It imports the GPG key manually and sets up the git configuration for signing commits.
# The action then performs a signed git commit and push to the specified branch.
#
# HOW TO USE:
#
# To call this reusable action, copy the code between === lines to workflow file,
# uncomment and adjust "uses" as needed (use the latest tag available).
# ======================================================================
# on:
#
#     (...)
#     steps:
#     (...)
#       - name: Commit changes Signed
#         uses: OutSystems/rd.github-reusable-workflows/.github/actions/signed-commit@vTagVersion
#         with:
#           commit-branch: ${{ BRANCH_NAME }}
#           commit-message: ${{ COMMIT_MESSAGE }}
#           commit-new-files: ${{ true || false }}
#           gpg-priv-key: ${{ GPG_SIGN_KEY }}
#           gpg-pass-phrase: ${{ GPG_PASSPHRASE }}
#
# ======================================================================
#

name: Signed GPG Commit
description: 'Prepare and sign the commit signed'
inputs:
    commit-branch:
        description: 'Branch where to commit.'
        required: true
        default: ''
    commit-message:
        description: 'Commit message.'
        required: true
        default: ''
    commit-new-files:
        description: 'Defines if a `git add.` should be made or not.'
        required: false
        default: false
    gpg-priv-key:
        description: 'GPG Private key.'
        required: true
        default: ''
    gpg-pass-phrase:
        description: 'GPG passphrase.'
        required: false
        default: '""'

runs:
    using: composite
    steps:
        - name: Configure GPG for non-interactive use
          shell: bash
          run: |
              mkdir -p ~/.gnupg
              chmod 700 ~/.gnupg
              cat > ~/.gnupg/gpg-agent.conf << EOF
              allow-loopback-pinentry
              allow-preset-passphrase
              EOF
              cat > ~/.gnupg/gpg.conf << EOF
              pinentry-mode loopback
              use-agent
              EOF
              chmod 600 ~/.gnupg/gpg-agent.conf ~/.gnupg/gpg.conf
              gpgconf --kill gpg-agent || true
              gpg-connect-agent reloadagent /bye || true

        - name: Import GPG key and configure git
          shell: bash
          env:
              GPG_PRIVATE_KEY: ${{ inputs.gpg-priv-key }}
          run: |
              # Import the key
              echo "$GPG_PRIVATE_KEY" | gpg --batch --import
              
              # Get the key ID and fingerprint
              KEY_ID=$(gpg --list-secret-keys --keyid-format LONG | grep sec | head -1 | awk '{print $2}' | cut -d'/' -f2)
              FINGERPRINT=$(gpg --list-secret-keys --with-colons | grep fpr | head -1 | cut -d':' -f10)
              
              # Get the user identity from the key
              USER_ID=$(gpg --list-secret-keys --keyid-format LONG | grep uid | head -1 | sed 's/.*] //')
              USER_EMAIL=$(echo "$USER_ID" | grep -oP '<\K[^>]+' || echo "")
              USER_NAME=$(echo "$USER_ID" | sed 's/ <.*//')
              
              # Configure git to use this key for signing
              git config --global user.signingkey $KEY_ID
              git config --global commit.gpgsign true
              git config --global gpg.program gpg
              
              # Configure git user from the key
              if [ -n "$USER_EMAIL" ]; then
                  git config --global user.email "$USER_EMAIL"
              fi
              if [ -n "$USER_NAME" ]; then
                  git config --global user.name "$USER_NAME"
              fi
              
              # Trust the key ultimately (6 = ultimate trust)
              echo "${FINGERPRINT}:6:" | gpg --import-ownertrust

        - name: Add new files (if needed)
          shell: bash
          if: ${{ inputs.commit-new-files == 'true' }}
          run: |
              git add .

        - name: Commit and push
          shell: bash
          env:
              GPG_PASSPHRASE: ${{ inputs.gpg-pass-phrase }}
          run: |
              # Get the key grip for presetting passphrase
              KEY_ID=$(git config --get user.signingkey)
              KEYGRIP=$(gpg --list-secret-keys --with-keygrip $KEY_ID | grep Keygrip | head -1 | awk '{print $3}')
              
              # Ensure gpg-agent is running with correct config
              gpgconf --kill gpg-agent || true
              gpg-connect-agent /bye || true
              
              # Preset the passphrase in gpg-agent
              if [ -n "$GPG_PASSPHRASE" ] && [ "$GPG_PASSPHRASE" != '""' ]; then
                  /usr/lib/gnupg/gpg-preset-passphrase --preset "$KEYGRIP" <<< "$GPG_PASSPHRASE"
              fi
              
              git commit -m "${{ inputs.commit-message }}"
              git push origin ${{ inputs.commit-branch }}
